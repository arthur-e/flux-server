<!DOCTYPE html>

<html>
<head>
  <title>core.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="flux-server.html">
                flux-server.js
              </a>
            
              
              <a class="source" href="grid.html">
                grid.js
              </a>
            
              
              <a class="source" href="scenario.html">
                scenario.js
              </a>
            
              
              <a class="source" href="stats.html">
                stats.js
              </a>
            
              
              <a class="source" href="t.html">
                t.js
              </a>
            
              
              <a class="source" href="uncertainty.html">
                uncertainty.js
              </a>
            
              
              <a class="source" href="xy.html">
                xy.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>core.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> mongo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>).MongoClient;
<span class="hljs-keyword">var</span> PROJ_DIR = <span class="hljs-string">'/usr/local/project/flux-server'</span>;
<span class="hljs-keyword">var</span> PRECISION = <span class="hljs-number">2</span>; <span class="hljs-comment">// Floating-point precision for Flux measurements</span>
<span class="hljs-keyword">var</span> VARIANCE_PRECISION = <span class="hljs-number">3</span>; <span class="hljs-comment">// Floating-point precision for Flux measurements</span>
<span class="hljs-keyword">var</span> INDEX = {}; <span class="hljs-comment">// The INDEX contains the ordered arrangement of model cells</span>
<span class="hljs-keyword">var</span> REGEX = {
    iso8601: <span class="hljs-regexp">/^\d{4}(-\d{2})?(-\d{2})?(T\d{2}:\d{2})?(:\d{2})?/</span>,
    monthly: <span class="hljs-regexp">/^(\d{4})\-(\d{2})$/</span>, <span class="hljs-comment">// e.g. 2004-05</span>
    yearly: <span class="hljs-regexp">/^(\d{4})/</span>, <span class="hljs-comment">// e.g. 2004</span>
    wktPoint: <span class="hljs-regexp">/^POINT\((-?[\d\.]+)[ +]?(-?[\d\.]+)\)$/</span>
};
<span class="hljs-keyword">var</span> AGGREGATES = {
    <span class="hljs-string">'net'</span>: <span class="hljs-string">'$sum'</span>,
    <span class="hljs-string">'mean'</span>: <span class="hljs-string">'$avg'</span>,
    <span class="hljs-string">'min'</span>: <span class="hljs-string">'$min'</span>,
    <span class="hljs-string">'max'</span>: <span class="hljs-string">'$max'</span>,
    <span class="hljs-string">'positive'</span>: <span class="hljs-string">'$gte'</span>,
    <span class="hljs-string">'negative'</span>: <span class="hljs-string">'$lte'</span>
};
<span class="hljs-keyword">var</span> INTERVALS = {
    <span class="hljs-string">'daily'</span>: {
        day: { <span class="hljs-string">'$dayOfYear'</span>: <span class="hljs-string">'$_id'</span> },
        year: { <span class="hljs-string">'$year'</span>: <span class="hljs-string">'$_id'</span> },
        values: <span class="hljs-number">1</span>
    },
    <span class="hljs-string">'monthly'</span>: {
        month: { <span class="hljs-string">'$month'</span>: <span class="hljs-string">'$_id'</span> },
        year: { <span class="hljs-string">'$year'</span>: <span class="hljs-string">'$_id'</span> },
        values: <span class="hljs-number">1</span>
    },
    <span class="hljs-string">'annual'</span>: {
        year: { <span class="hljs-string">'$year'</span>: <span class="hljs-string">'$_id'</span> },
        values: <span class="hljs-number">1</span>
    }
};
<span class="hljs-keyword">var</span> db = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">var</span> scenarios = [];
<span class="hljs-keyword">var</span> metadata = {};
<span class="hljs-keyword">var</span> data = {};

<span class="hljs-keyword">var</span> core = {
    init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(app)</span> {</span>
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="https://groups.google.com/forum/#!msg/node-mongodb-native/mSGnnuG8C1o/Hiaqvdu1bWoJ">See discussion</a> on this design pattern.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        mongo.connect(<span class="hljs-string">'mongodb://localhost:27017/fluxvis'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, db)</span> {</span>
            <span class="hljs-keyword">var</span> body = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> console.dir(err);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Grab the list of scenarios stored in mongo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            db.collection(<span class="hljs-string">'metadata'</span>).find({}, {
                <span class="hljs-string">'_id'</span>:<span class="hljs-number">1</span>
            }).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, results)</span> {</span>
                <span class="hljs-keyword">var</span> i;
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; results.length; i+=<span class="hljs-number">1</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Array containing the scenario strings. This is returned by the
scenarios endpoint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    scenarios.push(results[i]._id);

                    data[results[i]._id] = db.collection(results[i]._id);

                };                
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Grab the metadata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            db.collection(<span class="hljs-string">'metadata'</span>).find().toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> {</span>
                <span class="hljs-keyword">var</span> i;
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; docs.length; i+=<span class="hljs-number">1</span>) {
                    metadata[docs[i]._id] = docs[i];                    
                };
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Grab the indices</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            db.collection(<span class="hljs-string">'coord_index'</span>).find().toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, idx)</span> {</span>
                <span class="hljs-keyword">var</span> i;
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; idx.length; i+=<span class="hljs-number">1</span>) {
                    INDEX[idx[i]._id] = idx[i].i;
                };
            });

        });

        self.PROJ_DIR           = PROJ_DIR;
        self.PRECISION          = PRECISION;
        self.VARIANCE_PRECISION = VARIANCE_PRECISION;
        self.INDEX              = INDEX;
        self.REGEX              = REGEX;
        self.AGGREGATES         = AGGREGATES;
        self.INTERVALS          = INTERVALS;
        self.SCENARIOS          = scenarios;
        self.METADATA           = metadata;
        self.DATA               = data;
        self.DB                 = db;

        self.app = (app) ? app : <span class="hljs-literal">null</span>;

    },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p> Given a WKT Point string, extracts and returns the coordinates:</p>
<pre><code>@param  wktPointString  {<span class="hljs-built_in">String</span>}  e.g. <span class="hljs-string">"POINT(-83 42)"</span>
@<span class="hljs-keyword">return</span>                 {<span class="hljs-built_in">Number</span>}  The index of the model resolution cell
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    
    pointCoords: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(wktPointString)</span> {</span>
        <span class="hljs-keyword">if</span> (REGEX.wktPoint.test(wktPointString)) {
            <span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> r = REGEX.wktPoint.exec(wktPointString);
                <span class="hljs-keyword">return</span> r.slice(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>).map(<span class="hljs-built_in">Number</span>);
            }())

        }

    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Extracts and formats a keyword representation of a time unit from a String:</p>
<pre><code>@param  timeString  {<span class="hljs-built_in">String</span>}
@<span class="hljs-keyword">return</span>             {<span class="hljs-built_in">Number</span> || <span class="hljs-built_in">String</span>}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre> 
    uncertaintyTime: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(timeString)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>As of this time, only monthly and annual (yearly) uncertainties are available</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (REGEX.monthly.test(timeString)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The month of the year e.g. ‘5’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(REGEX.monthly.exec(timeString).pop()).toString();

        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (REGEX.yearly.test(timeString)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'ann'</span>; <span class="hljs-comment">// Short for "annual"; multi-year data not known or available</span>

        }

    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Given point coordinates, looks up the index of the corresponding resolution
cell’s coordinates.</p>
<pre><code>@param  coords  {<span class="hljs-built_in">Array</span>}     e.g. [-<span class="hljs-number">83</span>, <span class="hljs-number">42</span>]
@param  scn     {<span class="hljs-built_in">String</span>}    e.g. <span class="hljs-string">"zerozero_orch_shortaft_10twr"</span>
@<span class="hljs-keyword">return</span>         {<span class="hljs-built_in">Number</span>}    The index of the model resolution cell
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    
    getCellIndex: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(coords, scn)</span> {</span>
        <span class="hljs-keyword">var</span> i, idx;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Dirty validation. This could be improved, probably.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (INDEX[scn] === <span class="hljs-literal">undefined</span>) {
            <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Find the corresponding index of the grid cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (i &lt; INDEX[scn].length) {
            <span class="hljs-keyword">if</span> (INDEX[scn][i][<span class="hljs-number">0</span>] === coords[<span class="hljs-number">0</span>] &amp;&amp; INDEX[scn][i][<span class="hljs-number">1</span>] === coords[<span class="hljs-number">1</span>]) {
                idx = i;
                <span class="hljs-keyword">break</span>;
            }
            i += <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">return</span> idx;
    }
};

exports.core = core;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
