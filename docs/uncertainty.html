<!DOCTYPE html>

<html>
<head>
  <title>uncertainty.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="flux-server.html">
                flux-server.js
              </a>
            
              
              <a class="source" href="grid.html">
                grid.js
              </a>
            
              
              <a class="source" href="scenario.html">
                scenario.js
              </a>
            
              
              <a class="source" href="stats.html">
                stats.js
              </a>
            
              
              <a class="source" href="t.html">
                t.js
              </a>
            
              
              <a class="source" href="uncertainty.html">
                uncertainty.js
              </a>
            
              
              <a class="source" href="xy.html">
                xy.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>uncertainty.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> core = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../core'</span>).core;
<span class="hljs-keyword">var</span> numeric = <span class="hljs-built_in">require</span>(<span class="hljs-string">'numeric'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>GET Parameters:</p>
<pre><code>time          [Optional]  Used <span class="hljs-keyword">with</span>: covarianceAt
covarianceAt  [Optional]  Used <span class="hljs-keyword">with</span>: time
source        [Optional]  Used <span class="hljs-keyword">with</span>: start, end, target
target        [Optional]  Used <span class="hljs-keyword">with</span>: start, end, source
start         [Optional]  Used <span class="hljs-keyword">with</span>: end, source, target
end           [Optional]  Used <span class="hljs-keyword">with</span>: start, source, target

Valid combinations:
    (time),
    (time, covarianceAt),
    (start, end),
    (start, end, source, target),
    (source, target)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uncert</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> argument, collection, coords, idx, start, end, source, target;

    collection = core.DATA[req.params.scenario];

    <span class="hljs-keyword">if</span> (collection === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
    }

    numeric.precision = core.VARIANCE_PRECISION;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="time">time</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'time'</span>)) {

        argument = core.uncertaintyTime(req.query.time);

        <span class="hljs-keyword">if</span> (!argument) <span class="hljs-keyword">return</span> es.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>covarianceAt</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'covarianceAt'</span>)) {
            coords = core.pointCoords(req.query.covarianceAt);
            idx = core.getCellIndex(coords);

            result = collection.find({
                <span class="hljs-string">'_id'</span>: <span class="hljs-built_in">String</span>(argument) + <span class="hljs-string">'.'</span> + <span class="hljs-built_in">String</span>(idx)
            }).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> {</span>
                <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> console.log(err);
                <span class="hljs-keyword">if</span> (docs.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);

                body = {
                    <span class="hljs-string">'timestamp'</span>: argument,
                    <span class="hljs-string">'properties'</span>: {
                        <span class="hljs-string">'covarianceAt'</span>: {
                            <span class="hljs-string">'coordinates'</span>: coords
                        }
                    },
                    <span class="hljs-string">'features'</span>: []
                }

                docs[<span class="hljs-number">0</span>].v.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, i)</span> {</span>
                    body.features.push({
                        <span class="hljs-string">'covariance'</span>: v.toFixed(core.VARIANCE_PRECISION),
                        <span class="hljs-string">'coordinates'</span>: core.INDEX[req.params.scenario][i]
                    });
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Send the response as a JSON object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> res.send(body);

            });

        } <span class="hljs-keyword">else</span> {

            collection.find({ <span class="hljs-comment">// e.g. matches "ann.141" or "5.141"</span>
                <span class="hljs-string">'_id'</span>: {<span class="hljs-string">'$regex'</span>: <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + argument + <span class="hljs-string">'\\.\\d+$'</span>)}
            }).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> {</span>
                <span class="hljs-keyword">var</span> i;

                <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> console.log(err);
                <span class="hljs-keyword">if</span> (docs.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);

                body = {
                    <span class="hljs-string">'timestamp'</span>: argument,
                    <span class="hljs-string">'features'</span>: []
                }

                docs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> {</span>
                    <span class="hljs-keyword">var</span> i = <span class="hljs-built_in">Number</span>(doc._id.split(<span class="hljs-string">'.'</span>).pop());</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>For a covariance matrix: Insert Array at the proper index
 and trim it according to its position—generates a
 lower-triangular matrix</p>
<p>Set outside the loop:</p>
<p><code>body.values.length = core.INDEX[req.params.scenario].length;</code></p>
<p>Then:</p>
<p><code>body.values[i] = doc.v.slice(0, i + 1);</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    body.features.push({
                        <span class="hljs-string">'variance'</span>: doc.v[i].toFixed(core.VARIANCE_PRECISION),
                        <span class="hljs-string">'coordinates'</span>: core.INDEX[req.params.scenario][i]
                    });

                });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Send the response as a JSON object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> res.send(body);
            });

        }

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'source'</span>) || _.has(req.query, <span class="hljs-string">'start'</span>)) {

        <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'source'</span>)) {
            <span class="hljs-keyword">if</span> (!_.has(req.query, <span class="hljs-string">'target'</span>)) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="source-target-start-end">source, target, start, end</h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'start'</span>)) {
                <span class="hljs-keyword">if</span> (!_.has(req.query, <span class="hljs-string">'end'</span>)) <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

                start = core.uncertaintyTime(req.query.start);
                end = core.uncertaintyTime(req.query.end);

                <span class="hljs-keyword">if</span> (!start || !end || start === <span class="hljs-string">'ann'</span> || end === <span class="hljs-string">'ann'</span>) <span class="hljs-keyword">return</span> es.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

                source = core.pointCoords(req.query.source);
                target = core.pointCoords(req.query.target);

                <span class="hljs-keyword">if</span> (!source || !target) <span class="hljs-keyword">return</span> es.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">501</span>, <span class="hljs-string">'Not Implemented'</span>); <span class="hljs-comment">//TODO</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="source-target">source, target</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">501</span>, <span class="hljs-string">'Not Implemented'</span>); <span class="hljs-comment">//TODO</span>

            }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="start-end">start, end</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'start'</span>)) {

            <span class="hljs-keyword">if</span> (!_.has(req.query, <span class="hljs-string">'end'</span>)) <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">501</span>, <span class="hljs-string">'Not Implemented'</span>); <span class="hljs-comment">//TODO</span>

        }

    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

    }

};



exports.uncert = uncert;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
