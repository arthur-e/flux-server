<!DOCTYPE html>

<html>
<head>
  <title>t.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="flux-server.html">
                flux-server.js
              </a>
            
              
              <a class="source" href="grid.html">
                grid.js
              </a>
            
              
              <a class="source" href="scenario.html">
                scenario.js
              </a>
            
              
              <a class="source" href="stats.html">
                stats.js
              </a>
            
              
              <a class="source" href="t.html">
                t.js
              </a>
            
              
              <a class="source" href="uncertainty.html">
                uncertainty.js
              </a>
            
              
              <a class="source" href="xy.html">
                xy.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>t.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> core = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../core'</span>).core;
<span class="hljs-keyword">var</span> moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../node_modules/moment/moment'</span>);
<span class="hljs-keyword">var</span> numeric = <span class="hljs-built_in">require</span>(<span class="hljs-string">'numeric'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>GET Parameters:</p>
<pre><code>aggregate   [Optional]  Used <span class="hljs-keyword">with</span>: coords, interval, start, end, geom
coords      [Optional]  Used <span class="hljs-keyword">with</span>: aggregate, interval, start, end
end         [Optional]  Used <span class="hljs-keyword">with</span>: aggregate, coords, interval, start, geom
geom        [Optional]  Used <span class="hljs-keyword">with</span>: aggregate, coords, start, end
interval    [Optional]  Used <span class="hljs-keyword">with</span>: aggregate, coords, start, end
start       [Optional]  Used <span class="hljs-keyword">with</span>: aggregate, coords, interval, end, geom

Valid combinations:
  (coords),
  (coords, start, end),
  (coords, start, end, aggregate),
  (coords, start, end, aggregate, interval),
  (geom, start, end, aggregate)
  (geom, start, end, aggregate, interval),
  (start, end, aggregate, interval),
  (start, end, aggregate),
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">t</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> body, coords, grouping, i, idx, projection;
    <span class="hljs-keyword">var</span> collection = core.DATA[req.params.scenario];
    <span class="hljs-keyword">var</span> aggregate = {};

    <span class="hljs-keyword">if</span> (collection === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
    }

    <span class="hljs-keyword">if</span> (!_.has(req.query, <span class="hljs-string">'start'</span>) || !_.has(req.query, <span class="hljs-string">'end'</span>)) {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>start &amp;&amp; end parameter constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!core.REGEX.iso8601.test(req.query.start) || !core.REGEX.iso8601.test(req.query.end)) {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
    }

    numeric.precision = core.PRECISION;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="t-aggregation-in-space-or-time">T Aggregation in Space or Time</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'aggregate'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>aggregate parameter constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!_.contains([<span class="hljs-string">'positive'</span>, <span class="hljs-string">'negative'</span>, <span class="hljs-string">'net'</span>, <span class="hljs-string">'mean'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'max'</span>], req.query.aggregate)) {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>geom</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'geom'</span>)) {

            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">501</span>, <span class="hljs-string">'Not Implemented'</span>); <span class="hljs-comment">//TODO</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>coords</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'coords'</span>)) {

            <span class="hljs-keyword">if</span> (!_.has(req.query, <span class="hljs-string">'interval'</span>)) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>interval parameter constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!_.contains([<span class="hljs-string">'daily'</span>, <span class="hljs-string">'monthly'</span>, <span class="hljs-string">'annual'</span>], req.query.interval)) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Get the integer value of the cell index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            coords = core.pointCoords(req.query.coords);
            idx = core.getCellIndex(coords, req.params.scenario);

            <span class="hljs-keyword">if</span> (idx === <span class="hljs-literal">undefined</span>) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
            }

            collection.find({
                <span class="hljs-string">'_id'</span>: {
                    <span class="hljs-string">'$gte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.start),
                    <span class="hljs-string">'$lte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.end)
                }
            }).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> {</span>
                <span class="hljs-keyword">var</span> i = j = <span class="hljs-number">0</span>
                <span class="hljs-keyword">var</span> unit, t1;
                <span class="hljs-keyword">var</span> t0 = moment.utc(docs[<span class="hljs-number">0</span>]._id);
                <span class="hljs-keyword">var</span> ds = [];
                <span class="hljs-keyword">var</span> operation, subop;

                <span class="hljs-keyword">if</span> (err) console.log(err);

                <span class="hljs-keyword">switch</span> (req.query.aggregate) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'positive'</span>:
                    subop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(s)</span> {</span>
                        <span class="hljs-keyword">return</span> _.reduce(s, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(memo, v)</span> {</span>
                            <span class="hljs-keyword">return</span> (v &gt; <span class="hljs-number">0</span>) ? memo + v : memo;
                        }, <span class="hljs-number">0</span>);
                    };
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'negative'</span>:
                    subop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(s)</span> {</span>
                        <span class="hljs-keyword">return</span> _.reduce(s, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(memo, v)</span> {</span>
                            <span class="hljs-keyword">return</span> (v &lt; <span class="hljs-number">0</span>) ? memo + v : memo;
                        }, <span class="hljs-number">0</span>);
                    };
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'net'</span>:
                    subop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(s)</span> {</span>
                        <span class="hljs-keyword">return</span> _.reduce(s, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(memo, v)</span> {</span>
                            <span class="hljs-keyword">return</span> memo + v;
                        }, <span class="hljs-number">0</span>);
                    };
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'mean'</span>:
                    subop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(s)</span> {</span>
                        <span class="hljs-keyword">return</span> _.reduce(s, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(memo, v)</span> {</span>
                            <span class="hljs-keyword">return</span> (memo + v) * <span class="hljs-number">0.5</span>;
                        }, <span class="hljs-number">0</span>);
                    };
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'min'</span>:
                    subop = _.min;
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'max'</span>:
                    subop = _.max;
                    <span class="hljs-keyword">break</span>;
                }

                <span class="hljs-keyword">switch</span> (req.query.interval) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'hourly'</span>:
                    unit = <span class="hljs-string">'hour'</span>;
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'daily'</span>:
                    unit = <span class="hljs-string">'day'</span>;
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'monthly'</span>:
                    unit = <span class="hljs-string">'month'</span>;
                    <span class="hljs-keyword">break</span>;
                }

                operation = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(series)</span> {</span>
                    <span class="hljs-keyword">return</span> subop(_.map(series, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(serie)</span> {</span>
                        <span class="hljs-keyword">return</span> serie.values[idx];
                    }));
                };

                t1 = t0.clone().add(<span class="hljs-number">1</span>, unit);
                <span class="hljs-keyword">while</span> (j &lt; docs.length) {
                    <span class="hljs-keyword">if</span> (moment.utc(docs[j]._id).isSame(t1) || moment.utc(docs[j]._id).isAfter(t1)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Call the operation on the subsequence of data from the last
 time point to the current</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (!moment.utc(docs[j]._id).isSame(t1)) {
                            ds.push(operation.call(<span class="hljs-keyword">this</span>, docs.slice(i, j)));
                        } <span class="hljs-keyword">else</span> {
                            ds.push(operation.call(<span class="hljs-keyword">this</span>, docs.slice(i, j + <span class="hljs-number">1</span>)));
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Update the forward-looking timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        t1.add(<span class="hljs-number">1</span>, unit);
                        i = j;
                    }

                    j += <span class="hljs-number">1</span>;
                }

                <span class="hljs-keyword">return</span> res.send({
                    properties: {
                        aggregate: req.query.aggregate,
                        interval: req.query.interval,
                        start: req.query.start,
                        end: req.query.end,
                        coords: <span class="hljs-string">'POINT('</span> + coords.join(<span class="hljs-string">' '</span>) + <span class="hljs-string">')'</span>
                    },
                    series: _.map(ds, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> {</span>
                        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(d.toFixed(core.PRECISION));
                    })
                });

            });</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>interval? &amp;&amp; start &amp;&amp; end &amp;&amp; aggregate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'interval'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>interval parameter constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!_.contains([<span class="hljs-string">'daily'</span>, <span class="hljs-string">'monthly'</span>, <span class="hljs-string">'annual'</span>], req.query.interval)) {
                    <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
                }

                projection = core.INTERVALS[req.query.interval];
                grouping = {
                    <span class="hljs-string">'year'</span>: <span class="hljs-string">'$year'</span>,
                    <span class="hljs-string">'month'</span>: <span class="hljs-string">'$month'</span>,
                    <span class="hljs-string">'day'</span>: <span class="hljs-string">'$day'</span>,
                    <span class="hljs-string">'hour'</span>: <span class="hljs-string">'$hour'</span>,
                    <span class="hljs-string">'minute'</span>: <span class="hljs-string">'$minute'</span>
                };

            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Default to the temporal resolution of the data (no temporal
 aggregation)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                projection = {
                    <span class="hljs-string">'_id'</span>: <span class="hljs-string">'$_id'</span>,
                    <span class="hljs-string">'values'</span>: <span class="hljs-string">'$values'</span>
                };
                grouping = <span class="hljs-string">'$_id'</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>positive || negative</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (_.contains([<span class="hljs-string">'positive'</span>, <span class="hljs-string">'negative'</span>], req.query.aggregate)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Creates object aggregate e.g. {‘$gte’: 0}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-built_in">Object</span>.defineProperty(aggregate, core.AGGREGATES[req.query.aggregate], {
                    enumerable: <span class="hljs-literal">true</span>,
                    value: <span class="hljs-number">0</span>
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>New implementation using the aggregation framework.
 Response time averages around 4.3 seconds. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                collection.aggregate({
                    <span class="hljs-string">'$match'</span>: {
                        <span class="hljs-string">'_id'</span>: {
                            $gte: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.start),
                            $lte: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.end)
                        }
                    }
                }, {
                    <span class="hljs-string">'$project'</span>: projection
                }, {
                    <span class="hljs-string">'$unwind'</span>: <span class="hljs-string">'$values'</span>
                }, {
                    <span class="hljs-string">'$match'</span>: {
                        <span class="hljs-string">'values'</span>: aggregate
                    }
                }, {
                    <span class="hljs-string">'$group'</span>: {
                        <span class="hljs-string">'_id'</span>: grouping,
                        <span class="hljs-string">'values'</span>: { <span class="hljs-string">'$sum'</span>: <span class="hljs-string">'$values'</span> }
                    }
                }, {
                    <span class="hljs-string">'$sort'</span>: {
                        <span class="hljs-string">'_id'</span>: <span class="hljs-number">1</span>
                    }
                }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, results)</span> {</span>
                    <span class="hljs-keyword">if</span> (err) {
                        <span class="hljs-keyword">if</span> (err.code === <span class="hljs-number">16389</span>) {
                            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">413</span>, <span class="hljs-string">'Request Entity Too Large'</span>);
                        }

                        <span class="hljs-keyword">return</span> console.log(err);
                    }

                    <span class="hljs-keyword">return</span> res.send({
                        properties: {
                            aggregate: req.query.aggregate,
                            interval: req.query.interval,
                            start: req.query.start,
                            end: req.query.end
                        },
                        series: _.map(results, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> {</span>
                            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(doc.values.toFixed(core.PRECISION));
                        })
                    });
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>net || mean || min || max</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Creates object aggregate e.g. {‘$sum’: ‘$values’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-built_in">Object</span>.defineProperty(aggregate, core.AGGREGATES[req.query.aggregate], {
                    enumerable: <span class="hljs-literal">true</span>,
                    value: <span class="hljs-string">'$values'</span>
                });

                collection.aggregate({
                    <span class="hljs-string">'$match'</span>: {
                        <span class="hljs-string">'_id'</span>: {
                            <span class="hljs-string">'$gte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.start),
                            <span class="hljs-string">'$lte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.end)
                        }
                    }
                }, {
                    <span class="hljs-string">'$project'</span>: projection
                }, {
                    <span class="hljs-string">'$unwind'</span>: <span class="hljs-string">'$values'</span>
                }, {
                    <span class="hljs-string">'$group'</span>: {
                        <span class="hljs-string">'_id'</span>: grouping,
                        <span class="hljs-string">'values'</span>: aggregate
                    }
                }, {
                    <span class="hljs-string">'$sort'</span>: {
                        <span class="hljs-string">'_id'</span>: <span class="hljs-number">1</span>
                    }
                }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, results)</span> {</span>
                    <span class="hljs-keyword">if</span> (err) {
                        <span class="hljs-keyword">if</span> (err.code === <span class="hljs-number">16389</span>) {
                            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">413</span>, <span class="hljs-string">'Request Entity Too Large'</span>);
                        }

                        <span class="hljs-keyword">return</span> console.log(err);
                    }

                    <span class="hljs-keyword">return</span> res.send({
                        properties: {
                            aggregate: req.query.aggregate,
                            interval: req.query.interval,
                            start: req.query.start,
                            end: req.query.end
                        },
                        series: _.map(results, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> {</span>
                            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(doc.values.toFixed(core.PRECISION));
                        })
                    });
                });

            }

        }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="t-filtering-in-space">T Filtering in Space</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'coords'</span>)) {
        coords = core.pointCoords(req.query.coords);
        idx = core.getCellIndex(coords, req.params.scenario);

        <span class="hljs-keyword">if</span> (idx === <span class="hljs-literal">undefined</span>) {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
        }

        collection.find({
            <span class="hljs-string">'_id'</span>: {
                <span class="hljs-string">'$gte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.start),
                <span class="hljs-string">'$lte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.end)
            }
        }).sort({<span class="hljs-string">'_id'</span>: <span class="hljs-number">1</span>}).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, items)</span> {</span>
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> console.log(err);

            <span class="hljs-keyword">if</span> (items.length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!items[<span class="hljs-number">0</span>].hasOwnProperty(<span class="hljs-string">'values'</span>)) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
            }

            body = {
                series: items.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, i)</span> {</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(v.values[idx].toFixed(core.PRECISION));
                }),
                properties: {
                    start: req.query.start,
                    end: req.query.end,
                    coords: coords
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Send the response as a json object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            res.send(body);
        });

    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

    }

};

exports.t = t;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
