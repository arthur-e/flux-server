<!DOCTYPE html>

<html>
<head>
  <title>xy.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="flux-server.html">
                flux-server.js
              </a>
            
              
              <a class="source" href="grid.html">
                grid.js
              </a>
            
              
              <a class="source" href="scenario.html">
                scenario.js
              </a>
            
              
              <a class="source" href="stats.html">
                stats.js
              </a>
            
              
              <a class="source" href="t.html">
                t.js
              </a>
            
              
              <a class="source" href="uncertainty.html">
                uncertainty.js
              </a>
            
              
              <a class="source" href="xy.html">
                xy.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>xy.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> core = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../core'</span>).core;
<span class="hljs-keyword">var</span> numeric = <span class="hljs-built_in">require</span>(<span class="hljs-string">'numeric'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>GET Parameters:</p>
<pre><code>time        [Optional]  Used <span class="hljs-keyword">with</span>: [None]
start       [Optional]  Used <span class="hljs-keyword">with</span>: aggregate, end
end         [Optional]  Used <span class="hljs-keyword">with</span>: aggregate, start
aggregate   [Optional]  Used <span class="hljs-keyword">with</span>: start, end

Valid combinations:
    (time),
    (start, end),
    (start, end, aggregate)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xy</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> collection = core.DATA[req.params.scenario];
    <span class="hljs-keyword">var</span> metadata = core.METADATA[req.params.scenario];
    <span class="hljs-keyword">var</span> verbose = (_.has(req.query, <span class="hljs-string">'verbose'</span>));

    <span class="hljs-keyword">if</span> (collection === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
    }
    
    numeric.precision = core.PRECISION;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="xy-data-maps-">XY Data (Maps)</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'time'</span>)) {
        <span class="hljs-keyword">var</span> body, cursor, i;
        <span class="hljs-keyword">var</span> argument = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.time); <span class="hljs-comment">// Grab the date string from the query</span>

        <span class="hljs-keyword">if</span> (metadata.gridded) {
            cursor = collection.find({<span class="hljs-string">'_id'</span>: argument}); <span class="hljs-comment">// Gridded data uniquely indexed</span>
        } <span class="hljs-keyword">else</span> {
            cursor = collection.find({<span class="hljs-string">'timestamp'</span>: argument});
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Fetch the data from mongo and construct the JSON response
Note that the mongo find query can use the date object instead
of a constructed date string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cursor.toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, map)</span> {</span>
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> console.log(err);

            <span class="hljs-keyword">if</span> (map.length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
            }

            <span class="hljs-keyword">if</span> (verbose) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Emit a GeoJSON-compliant FeatureCollection instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                body = {
                    <span class="hljs-string">'timestamp'</span>: argument.toISOString(),
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'FeatureCollection'</span>,
                    <span class="hljs-string">'features'</span>: []
                };

                map[<span class="hljs-number">0</span>].values.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, i)</span> {</span>
                    <span class="hljs-keyword">if</span> (!v) {
                        <span class="hljs-keyword">return</span>;
                    }

                    body.features.push({
                        <span class="hljs-string">'type'</span>: <span class="hljs-string">'Point'</span>,
                        <span class="hljs-string">'coordinates'</span>: core.INDEX[req.params.scenario][i],
                        <span class="hljs-string">'properties'</span>: {
                            <span class="hljs-string">'v'</span>: <span class="hljs-built_in">Number</span>(v.toFixed(core.PRECISION)),
                        }
                    });
                });

             } <span class="hljs-keyword">else</span> {
                body = {
                    <span class="hljs-string">'timestamp'</span>: argument.toISOString(),
                    <span class="hljs-string">'features'</span>: []
                };

                map[<span class="hljs-number">0</span>].values.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, i)</span> {</span>
                    body.features.push((v) ? <span class="hljs-built_in">Number</span>(v.toFixed(core.PRECISION)) : v);
                });

            }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Send the response as a JSON object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> res.send(body);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="xy-aggregation-in-time-maps-">XY Aggregation in Time (Maps)</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'aggregate'</span>)) {

        <span class="hljs-keyword">if</span> (!metadata.gridded) { <span class="hljs-comment">// Aggregating non-gridded data is not supported</span>
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">501</span>, <span class="hljs-string">'Not Implemented'</span>);
        }

        <span class="hljs-keyword">if</span> (!_.has(req.query, <span class="hljs-string">'start'</span>) || !_.has(req.query, <span class="hljs-string">'end'</span>)) {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>start &amp;&amp; end parameter constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!core.REGEX.iso8601.test(req.query.start) || !core.REGEX.iso8601.test(req.query.end)) {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>aggregate parameter constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!_.contains([<span class="hljs-string">'positive'</span>, <span class="hljs-string">'negative'</span>, <span class="hljs-string">'net'</span>, <span class="hljs-string">'mean'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'max'</span>], req.query.aggregate)) {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Aggregation pipeline definition; can be modified later</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> definition = [{
            <span class="hljs-string">'$match'</span>: {
                <span class="hljs-string">'_id'</span>: {
                    <span class="hljs-string">'$gte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.start),
                    <span class="hljs-string">'$lte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.end)
                }
            }
        }, {
            <span class="hljs-string">'$sort'</span>: {<span class="hljs-string">'_id'</span>: <span class="hljs-number">1</span>}
        }];</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>What the response body should look like</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> template = {
            <span class="hljs-string">'timestamp'</span>: req.query.start,
            <span class="hljs-string">'properties'</span>: {
                <span class="hljs-string">'start'</span>: req.query.start,
                <span class="hljs-string">'end'</span>: req.query.end
            },
            <span class="hljs-string">'features'</span>: []
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>This will be consumed in one of the following conditionals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> result = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create an empty array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (i &lt; core.INDEX[req.params.scenario].length) {
            result.push(<span class="hljs-number">0</span>);
            i += <span class="hljs-number">1</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="min-max">min || max</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_.contains([<span class="hljs-string">'min'</span>, <span class="hljs-string">'max'</span>], req.query.aggregate)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Add the callback function to the argument list for the aggregate() pipeline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            definition.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> {</span>
                <span class="hljs-keyword">var</span> i, tpl;

                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">if</span> (err.code === <span class="hljs-number">16389</span>) {
                        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">413</span>, <span class="hljs-string">'Request Entity Too Large'</span>);
                    }

                    <span class="hljs-keyword">return</span> console.log(err);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Sum two Arrays at a time to get the total flux value in each cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _.each(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc, i)</span> {</span>
                    <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) { <span class="hljs-comment">// Start with the first document...</span>
                        result = doc.values;

                    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// ...Compare it to evey document afterwards</span>
                        _.each(doc.values, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, j)</span> {</span>
                            <span class="hljs-keyword">if</span> (req.query.aggregate === <span class="hljs-string">'min'</span>) {
                                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Number</span>(value) &lt; <span class="hljs-built_in">Number</span>(result[j])) result[j] = value; <span class="hljs-comment">// Update result with the max values</span>
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Number</span>(value) &gt; <span class="hljs-built_in">Number</span>(result[j])) result[j] = value; <span class="hljs-comment">// Update result with the min values</span>
                            }
                        });

                    }
                });

                tpl = _.clone(template);
                tpl.features = _.chain(result).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span> <span class="hljs-comment">// Convert to Number and fix precision</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(v.toFixed(core.PRECISION));
                }).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, i)</span> {</span> <span class="hljs-comment">// Format response body</span>
                    <span class="hljs-keyword">if</span> (verbose) {
                        <span class="hljs-keyword">return</span> {
                            <span class="hljs-string">'v'</span>: value,
                            <span class="hljs-string">'type'</span>: <span class="hljs-string">'Point'</span>, <span class="hljs-comment">// Required for compliant GeoJSON</span>
                            <span class="hljs-string">'coordinates'</span>: core.INDEX[req.params.scenario][i]
                        };
                    }

                    <span class="hljs-keyword">return</span> value;
                }).value()

                <span class="hljs-keyword">return</span> res.send(tpl);

            });</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="mean-net-positive-negative">mean || net || positive || negative</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.contains([<span class="hljs-string">'mean'</span>, <span class="hljs-string">'net'</span>, <span class="hljs-string">'positive'</span>, <span class="hljs-string">'negative'</span>], req.query.aggregate)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Add the callback function to the argument list for the aggregate() pipeline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            definition.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> {</span>
                <span class="hljs-keyword">var</span> i, tpl;

                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">if</span> (err.code === <span class="hljs-number">16389</span>) {
                        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">413</span>, <span class="hljs-string">'Request Entity Too Large'</span>);
                    }

                    <span class="hljs-keyword">return</span> console.log(err);
                }

                <span class="hljs-keyword">switch</span> (req.query.aggregate) {

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'negative'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Sum two Arrays at a time to get the total flux value in each cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    _.each(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> {</span>
                        result = numeric[<span class="hljs-string">'+'</span>](result, _.map(doc.values, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
                            <span class="hljs-keyword">return</span> (v &lt; <span class="hljs-number">0</span>) ? v : <span class="hljs-number">0</span>; <span class="hljs-comment">// Sum only negative fluxes</span>
                        }));
                    });
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'positive'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Sum two Arrays at a time to get the total flux value in each cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    _.each(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> {</span>
                        result = numeric[<span class="hljs-string">'+'</span>](result, _.map(doc.values, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
                            <span class="hljs-keyword">return</span> (v &gt; <span class="hljs-number">0</span>) ? v : <span class="hljs-number">0</span>; <span class="hljs-comment">// Sum only positive fluxes</span>
                        }));
                    });
                    <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Sum two Arrays at a time to get the total flux value in each cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    _.each(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> {</span>
                        result = numeric[<span class="hljs-string">'+'</span>](result, doc.values);
                    });
                    <span class="hljs-keyword">break</span>;

                }

                <span class="hljs-keyword">if</span> (req.query.aggregate === <span class="hljs-string">'mean'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Divide by the number of Arrays thus summed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    result = numeric.div(result, docs.length);
                }

                tpl = _.clone(template);
                tpl.features = _.chain(result).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span> <span class="hljs-comment">// Convert to Number and fix precision</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(v.toFixed(core.PRECISION));
                }).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, i)</span> {</span> <span class="hljs-comment">// Format response body</span>
                    <span class="hljs-keyword">if</span> (verbose) {
                        <span class="hljs-keyword">return</span> {
                            <span class="hljs-string">'v'</span>: value,
                            <span class="hljs-string">'type'</span>: <span class="hljs-string">'Point'</span>, <span class="hljs-comment">// Required for compliant GeoJSON</span>
                            <span class="hljs-string">'coordinates'</span>: core.INDEX[req.params.scenario][i]
                        };
                    }

                    <span class="hljs-keyword">return</span> value;
                }).value()

                <span class="hljs-keyword">return</span> res.send(tpl);

            });

        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

        }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Invoke the aggregation pipeline with the arguments and callback function definition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        collection.aggregate.apply(collection, definition) <span class="hljs-comment">// Updates "result" variable</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="xy-feature-collection">XY Feature Collection</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.has(req.query, <span class="hljs-string">'start'</span>) &amp;&amp; _.has(req.query, <span class="hljs-string">'end'</span>)) {

        <span class="hljs-keyword">if</span> (metadata.gridded) {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">501</span>, <span class="hljs-string">'Not Implemented'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>start &amp;&amp; end parameter constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!core.REGEX.iso8601.test(req.query.start) || !core.REGEX.iso8601.test(req.query.end)) {
            <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);
        }

        collection.find({
            <span class="hljs-string">'_id'</span>: {
                <span class="hljs-string">'$gte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.start),
                <span class="hljs-string">'$lte'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.query.end)
            }
        }).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, features)</span> {</span>
            <span class="hljs-keyword">var</span> body;

            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> console.log(err);

            <span class="hljs-keyword">if</span> (features.length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>);
            }

            <span class="hljs-keyword">return</span> res.send({
                <span class="hljs-string">'features'</span>: features
            });

        });

    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">400</span>, <span class="hljs-string">'Bad Request'</span>);

    }

};

exports.xy = xy;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
