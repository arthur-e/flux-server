# Carbon Data REST API

## Entry Points

    GET /flux/api/[scenario]/grid.json
    GET /flux/api/[scenario]/xy.json
    GET /flux/api/[scenario]/t.json
    GET /flux/api/[scenario]/t.csv
    GET /flux/api/[scenario]/stats.json
    GET /flux/api/[scenario]/uncertainty.json

## Resources

### Grid Geometry

    /flux/api/scenarios/<scenario>/grid.json
    
Example output, instance of a GeoJSON `MultiPoint`:
```
{
  "type": "MultiPoint",
  "coordinates": [
    [-166.5, 65.5],
    ...
  ]
}
```

**Client-side Models:**

    Flux.model.RasterGrid

### Metadata

    /flux/api/scenarios.json?scenario=<scenario>
    /flux/api/scenarios/<scenario>.json
    
Example output:
```
{
  "_id": "casa_gfed_2004",
  "bboxmd5": "6f3e33c145010bc74c5ccd3ba772f504",
  "dates": [
    "2003-12-22T03:00:00",
    "2005-01-01T00:00:00"
  ],
  "units": {
    "y": "degrees",
    "x": "degrees",
    "values": "&mu;mol/m&sup2;"
  },
  "steps": [10800],
  "bbox": [-166.5, 10.5, -50.5, 69.5],
  "title": "Surface Carbon Flux",
  "gridded": true,
  "stats": {
    "values": {
      "std": 1.4207932691264888,
      "max": 11.88084,
      "min": -58.21543,
      "median": 0.36982000000000004,
      "mean": -0.00713500735546471
    }
  },
  "grid": {
    "units": "degrees",
    "x": 1,
    "y": 1
  }
}
```

**Client-side Models:**

    Flux.model.Metadata

### Map Data (xy.json)

    /flux/api/scenarios/<scenario>/xy.json
    
Example output (raster case):
```
{
  "timestamp": "2003-12-22T03:00:00.000Z",
  "features": [
    0.08,
    0.15,
    ...
  ]
}
```

Example output (vector case):
```
{
  "timestamp": "2009-06-16",
  "features": [{
    "timestamp": "2009-06-16T00:00:00",
    "coordinates": [-175.488, -50.41476]
    "properties": {
      "value": "376.74",
      "error": "0.3677"
    }
  }, {
    ...
  }]
}
```

Example output, derivative of a GeoJSON `FeatureCollection`for the raster case, generated by passing the `verbose` flag:

```
{
  "timestamp": "2003-12-22T03:00:00.000Z",
  "type": "FeatureCollection",
  "features": [{
    "type": "Point",
    "coordinates": [-166.5, 65.5],
    "properties": {
      "v": 0.08
    }
  }, {
    ...
  }]
}
```

**Client-side Models:**

    Flux.model.Feature
    Flux.model.Raster
    
### Map Data as CSV (xy.csv)

ExtJS doesn't have anything like a `CSVReader` and it's probably more efficient for D3 to read the CSVs directly. Thus, the ExtJS model for CSV responses will simply be a "reference" to the CSV data.

**Client-side Models:**

    Flux.model.RasterReference

    
### Time Series Data (t.json)

    /flux/api/scenarios/<scenario>/t.json

Example output:
```
{
  "properties": {
    "start": "2003-12-22T03:00:00",
    "end": "2005-01-01T00:00:00"
  },
  "series": [
    0.27,
    0.42
    ...
  ]
}
```

**Client-side Models:**

    Flux.model.TimeSeries
    
## Use Cases

### Getting a Map (XY Data) ####################################################

#### Getting a Map at a Specified Time

    GET xy.json?time=2004-05-01T03:00:00

#### Aggregation in Time

The `aggregate` keyword is used to specify the kind of aggregate data desired. Here is an example of aggregation in time; aggregating total positive flux over a specified period. The aggregation is performed "element-wise" stacking maps (as arrays) together so as to produce a value for each grid cell.

    GET xy.json?start=2004-05-01T03:00:00&end=2004-06-01T03:00:00&aggregate=positive

And here is a map of net flux over a month for each grid cell:

    GET xy.json?start=2004-05-01T03:00:00&end=2004-05-02T03:00:00&aggregate=net

### Getting a Time Series ######################################################

As with the XY endpoint, the `aggregate` keyword is used to specify the kind of aggregate data desired. The `start` and `end` keywords are required in aggregation, but should not be used with the `coords` parameter.

#### Filtering in Space

The `t.json` endpoint requires that a single value be generated for each time step. With spatiotemporal data, this means that either spatial filtering or spatial aggregation is required. **Spatial filtering produces one value for each time step by selecting only one value among several based on that value's spatial location.** The `coords` parameter will do just that by selecting one point in a model. Here's an example of how to obtain a Time Series at a specified point in a spatiotemporal collection of rasters:

    GET t.json?coords=POINT(-50.5+69.5)

#### Aggregation in Space

**Spatial aggregation produces one value for each time step by aggregating values at different points in space, but at the same time, into one value for that time.** The `aggregate` parameter is used to specify the method by which the spatial dimension is aggregated into a single value for each time step. The available aggregates are:

| Keyword    | Description
| ---------- | --------------------------------------------
| `mean`     | Returns the arithmetic mean of the values
| `min`      | Returns the minimum value
| `max`      | Returns the maximum value
| `net`      | Returns the sum of the values
| `positive` | Returns the sum of only the positive values
| `negative` | Returns the sum of only the negative values

Here is an example of the mean value displayed for every time frame in the original dataset; it is presented at the same resolution as the non-aggregated data:

    GET t.json?start=2003-12-22T03:00:00&end=2005-01-01T00:00:00&aggregate=mean

**Filtering and aggregation can be done simultaneously.** The `geom` parameter is used to select a subset of same-time values based on their spatial location; these values are then aggregated to a single value for the time step they share. In cases where the `interval` parameter is also used (see next section), the same aggregate (defined by `aggregate`) is used to aggregate in both time and space i.e. the aggregate of the spatially-filtered values and the aggregate of each aggregate thus generated. The value of the `geom` parameter is an arbitrary `POINT()` or `POLYGON()` WKT string that specifies the spatial extent of the data to select. Here's an example of a polygon selection that is further aggregated to the net value:

    GET t.json?aggregate=net&start=2004-05-01&end=2004-06-01&geom=POLYGON(-50.5+69.5,-50.5+70,-50+70,-50+69.5,-50.5+69.5)
    
The `coords` parameter can also be used to filter data before aggregation.

    GET t.json?aggregate=net&start=2004-05-01&end=2004-06-01&coords=POINT(-50.5+69.5)

#### Aggregation in Both Space and Time

The `interval` parameter can be used to further aggregate in time. **It must be used with the `aggregate` parameter;** you have to specify how to downsample in time. If spatial filtering is also requested (with the `geom` parameter), then the specified aggregate is also applied over the spatial subset before being applied to each time step (e.g. the mean daily value of the means). Here is a time series of net daily flux across the entire dataset (in this case, net daily flux of North America) for each day of the month. 

    GET t.json?start=2003-12-22T03:00:00&end=2005-01-01T00:00:00&aggregate=mean&interval=daily

### Uncertainty Data: Covariance ###############################################

To get a map of the covariances associated with a particular model cell, use the `covarianceAt` parameter:

    GET uncertainty.json?time=2004-05&covarianceAt=POINT(-50.5 69.5)

A time series of covariance data can be obtained by specifying the associated cells and a range of time:

    GET uncertainty.json?start=2004-05&end=2004-06&source=POINT(-50.5 69.5)&target=POINT(-45.5 69.5)

### Uncertainty Data: Variance #################################################

The variances can be obtained for specified timesteps with the `time` parameter:

    GET uncertainty.json?time=2004-05

A time series of variances can be obtained by setting the `source` and `target` parameters to the same value (the same resolution cell):

    GET uncertainty.json?start=2004-05&end=2004-06&source=POINT(-50.5 69.5)&target=POINT(-50.5 69.5)

